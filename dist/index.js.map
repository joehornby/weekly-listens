{"version":3,"sources":["../index.ts"],"sourcesContent":["import { Octokit } from \"octokit\";\nimport fetch from \"node-fetch\";\nimport {\n  type LastFMArtistGetInfoResponse,\n  type LastFMUserGetTopArtistsResponse,\n} from \"./types.js\";\nimport {\n  type GetResponseTypeFromEndpointMethod,\n  type GetResponseDataTypeFromEndpointMethod,\n} from \"@octokit/types\";\nimport stringWidth from \"string-width\";\n\nconst MAX_NUM_ARTISTS = 5;\n\nconst config = {\n  gistId: process.env.GIST_ID,\n  githubToken: process.env.GH_TOKEN,\n  lastfmKey: process.env.LASTFM_KEY,\n  lastfmUsername: process.env.LASTFM_USERNAME,\n};\ntype Config = typeof config;\n\nconst octokit = new Octokit({\n  auth: `${config.githubToken}`,\n});\n\ntype GistResponseType = GetResponseTypeFromEndpointMethod<\n  typeof octokit.rest.gists.get\n>;\ntype GistResponseDataType = GetResponseDataTypeFromEndpointMethod<\n  typeof octokit.rest.gists.get\n>;\n\nasync function main() {\n  // Check for missing environment variables\n  if (\n    !config.gistId ||\n    !config.githubToken ||\n    !config.lastfmKey ||\n    !config.lastfmUsername\n  ) {\n    throw new Error(\"Required env vars are missing\");\n  }\n\n  try {\n    const gist = await getGist(config.gistId);\n    const artists = await getTopArtists(config);\n    const formattedContent = await createTopArtistList(\n      artists,\n      MAX_NUM_ARTISTS,\n      config\n    );\n\n    const title = `🎧 This week's soundtrack ${\n      new Date().toISOString().split(\"T\")[0]\n    }`;\n    if (process.env.NODE_ENV === \"development\") {\n      console.log(\"Gist would be updated with this content in production:\\n\");\n      console.log(title);\n      console.log(formattedContent);\n    } else {\n      await updateGist(gist, title, formattedContent, config);\n    }\n  } catch (error) {\n    console.error(\"An error occurred:\", error);\n  }\n}\n\nasync function getGist<GistResponseDataType>(id: string) {\n  try {\n    return await octokit.rest.gists.get({\n      gist_id: id,\n    });\n  } catch (error) {\n    console.error(`Error fetching gist: ${id}:`, error);\n    throw new Error(\n      `Failed to fetch gist: ${error instanceof Error ? error.message : error}`\n    ); // Re-throw error to handle in main\n  }\n}\n\nasync function getTopArtists(config: Config) {\n  const { lastfmKey, lastfmUsername } = config;\n  const API_BASE =\n    \"http://ws.audioscrobbler.com/2.0/?method=user.gettopartists&format=json&period=7day&\";\n  const API_ENDPOINT = `${API_BASE}user=${lastfmUsername}&api_key=${lastfmKey}&limit=${MAX_NUM_ARTISTS}`;\n  const response = await fetch(API_ENDPOINT);\n  if (!response.ok) {\n    throw new Error(\n      `Last.fm API request failed with status ${response.status}`\n    );\n  }\n  const {\n    topartists: { artist },\n  } = (await response.json()) as LastFMUserGetTopArtistsResponse;\n  return artist;\n}\n\nasync function createTopArtistList(\n  artists: LastFMUserGetTopArtistsResponse[\"topartists\"][\"artist\"],\n  listLength: number,\n  config: Config\n) {\n  const numberOfArtists = Math.min(listLength, artists.length);\n\n  const totalPlays = artists\n    .slice(0, numberOfArtists)\n    .reduce((total, { playcount }) => total + parseInt(playcount, 10), 0);\n\n  const lines = await Promise.all(\n    artists.map(async ({ name, playcount }, index) => {\n      // Find out if artist is new this week\n      const isNewThisWeek = await isArtistNewThisWeek(\n        name,\n        parseInt(playcount, 10),\n        config\n      );\n\n      name = `${name}${isNewThisWeek ? \" *\" : \"\"}`;\n\n      // format table entry\n      name = adjustAndPad(name.substring(0, 27), 28);\n      const plays = parseInt(playcount, 10);\n      const bar = generateChart(plays / totalPlays, 12);\n\n      return `${name} ${bar} ${plays.toString().padStart(5, \" \")} plays`;\n    })\n  );\n\n  return lines.join(\"\\n\") + `\\n\\n* = new this week`;\n}\n\nfunction adjustAndPad(str: string, maxWidth: number) {\n  const width = stringWidth(str);\n\n  // If it fits, just pad it\n  if (width <= maxWidth) {\n    return str + \" \".repeat(maxWidth - width);\n  }\n\n  // Otherwise, truncate it carefully around full characters\n  let truncatedStr = \"\";\n  let currentWidth = 0;\n\n  for (const char of str) {\n    const charWidth = stringWidth(char);\n    if (currentWidth + charWidth > maxWidth) {\n      break;\n    }\n    truncatedStr += char;\n    currentWidth += charWidth;\n  }\n\n  const paddingNeeded = maxWidth - stringWidth(truncatedStr);\n  return truncatedStr + \" \".repeat(paddingNeeded);\n}\n\nfunction testAdjustAndPad() {\n  console.log(\"=== Testing adjustAndPad function ===\");\n\n  // Test with East Asian characters\n  console.log(\"\\n--- East Asian Characters ---\");\n  testCase(\"你好世界\", 8, \"你好世界\", \"Chinese characters\");\n  testCase(\"こんにちは\", 10, \"こんにちは\", \"Japanese characters\");\n  testCase(\"안녕하세요\", 10, \"안녕하세요\", \"Korean characters\");\n\n  // Test with European accented characters\n  console.log(\"\\n--- European Accented Characters ---\");\n  testCase(\"café\", 6, \"café  \", \"é character\");\n  testCase(\"München\", 8, \"München \", \"ü character\");\n  testCase(\"François\", 10, \"François  \", \"ç character\");\n  testCase(\"Dvořák\", 7, \"Dvořák \", \"ř character\");\n\n  // Test with mixed characters\n  console.log(\"\\n--- Mixed Characters ---\");\n  testCase(\"Tokyo東京\", 10, \"Tokyo東京 \", \"mixed Latin and East Asian\");\n  testCase(\"Café☕\", 7, \"Café☕ \", \"Latin with emoji\");\n\n  // Korean example - based on character analysis, we know it should truncate after \"소년\"\n  testCase(\n    \"BTS (방탄소년단)\",\n    15,\n    \"BTS (방탄소년단\",\n    \"Korean group name with parentheses\"\n  );\n\n  // Test with truncation\n  console.log(\"\\n--- Truncation Tests ---\");\n  testCase(\"你好世界Hello\", 8, \"你好世界\", \"truncation of mixed characters\");\n  testCase(\"Beyoncé\", 4, \"Beyo\", \"truncation with accented character\");\n\n  // BLACKPINK example - based on character analysis, we know BLACKPINK is width 9\n  // and max width is 10, so it should be \"BLACKPINK \" (with one space)\n  testCase(\"BLACKPINK블랙핑크\", 10, \"BLACKPINK \", \"truncation at boundary\");\n\n  // Edge cases\n  console.log(\"\\n--- Edge Cases ---\");\n  testCase(\"\", 5, \"     \", \"empty string\");\n  testCase(\"a\", 0, \"\", \"zero width\");\n\n  // Emoji family example - we know the emoji is width 2, and \"Fa\" is width 2\n  // so with max width 8, it should fit \"👨‍👩‍👧‍👦Fami\" (emoji + 4 letters)\n  testCase(\"👨‍👩‍👧‍👦Family\", 8, \"👨‍👩‍👧‍👦Fami\", \"complex emoji\");\n  testCase(\"🎵🎶🎸\", 6, \"🎵🎶🎸\", \"multiple emojis\");\n\n  console.log(\"\\n=== All tests completed! ===\");\n}\n\n// Helper function to run a test case and report results\nfunction testCase(\n  input: string,\n  maxWidth: number,\n  expected: string,\n  description: string\n) {\n  const result = adjustAndPad(input, maxWidth);\n  const resultWidth = stringWidth(result);\n  const expectedWidth = stringWidth(expected);\n\n  console.log(\n    `Testing: \"${input}\" (width: ${stringWidth(input)}) → max width ${maxWidth}`\n  );\n  console.log(`Result: \"${result}\" (width: ${resultWidth})`);\n\n  if (result === expected) {\n    console.log(`✅ PASSED: ${description}`);\n  } else {\n    console.log(`❌ FAILED: ${description}`);\n    console.log(`   Expected: \"${expected}\" (width: ${expectedWidth})`);\n    console.log(`   Actual:   \"${result}\" (width: ${resultWidth})`);\n  }\n\n  // Also verify the width is correct\n  if (resultWidth !== maxWidth) {\n    console.log(\n      `⚠️ WARNING: Result width ${resultWidth} doesn't match target width ${maxWidth}`\n    );\n  }\n}\n\n// Run the tests\ntestAdjustAndPad();\n\nfunction generateChart(fraction: number, size: number) {\n  const position = Math.floor(fraction * size);\n  return \"–\".repeat(position) + \"|\" + \"–\".repeat(size - position - 1);\n}\n\nasync function isArtistNewThisWeek(\n  name: string,\n  playcount: number,\n  config: Config\n) {\n  const { lastfmKey, lastfmUsername } = config;\n  const API_ENDPOINT = `http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist=${name}&username=${lastfmUsername}&api_key=${lastfmKey}&format=json`;\n  try {\n    const response = await fetch(API_ENDPOINT);\n    if (!response.ok) {\n      throw new Error(\n        `Last.fm API request failed with status ${response.status}`\n      );\n    }\n    const {\n      artist: {\n        stats: { userplaycount },\n      },\n    } = (await response.json()) as LastFMArtistGetInfoResponse;\n\n    return (\n      userplaycount !== undefined && playcount === parseInt(userplaycount, 10)\n    );\n  } catch {\n    console.error(`Failed to check if ${name} is new this week`);\n    return false;\n  }\n}\n\nasync function updateGist(\n  gist: GetResponseTypeFromEndpointMethod<typeof octokit.rest.gists.get>,\n  title: string,\n  content: string,\n  config: Config\n) {\n  try {\n    const filename = gist.data.files ? Object.keys(gist.data.files)[0] : \"\";\n\n    await octokit.rest.gists.update({\n      gist_id: config.gistId!,\n      files: {\n        [filename]: {\n          filename: `🎧 This week's soundtrack ${\n            new Date().toISOString().split(\"T\")[0]\n          }`,\n          content,\n        },\n      },\n    });\n  } catch (error) {\n    console.error(`Unable to update gist:\\n${error}`);\n    throw new Error(\n      `Failed to update gist: ${error instanceof Error ? error.message : error}`\n    ); // Re-throw error to handle in main\n  }\n}\n\n(async () => {\n  await main();\n})();\n"],"mappings":"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","names":["config"]}